<%@ page import="java.util.List" %>
<%@ page import="java.util.HashMap" %>
<%@ page import="java.util.Map" %>
<%@ page import="model1.board.BoardDAO" %>
<%@ page import="model1.board.BoardDTO" %>
<%@ page import="utils.BoardPage" %>
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%
// DAO 생성
BoardDAO dao = new BoardDAO(application);

// 검색 조건 처리
String searchField = request.getParameter("searchField");
String searchWord = request.getParameter("searchWord");

// 기본 검색 필드 설정
if (searchField == null || searchField.isEmpty()) {
    searchField = "title"; // 기본 검색 필드를 제목으로 설정
}

Map<String, Object> map = new HashMap<>();
map.put("searchField", searchField);
map.put("searchWord", searchWord);

// 전체 게시물 수 조회
int totalCount = dao.selectCount(map);

// 페이징 처리
int pageSize = Integer.parseInt(application.getInitParameter("POSTS_PER_PAGE"));
int blockPage = Integer.parseInt(application.getInitParameter("PAGES_PER_BLOCK"));
int totalPage = (int) Math.ceil((double) totalCount / pageSize);

int pageNum = 1; // 기본 페이지 번호
String pageTemp = request.getParameter("pageNum");
if (pageTemp != null && !pageTemp.isEmpty()) {
    pageNum = Integer.parseInt(pageTemp);
}

int start = (pageNum - 1) * pageSize;
map.put("start", start);
map.put("pageSize", pageSize);

List<BoardDTO> boardLists = dao.selectListPage(map); // 게시물 목록 조회

dao.close(); // DAO 닫기
%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>회원제 게시판</title>
</head>
<body>
<jsp:include page="../Common/Link.jsp" /> <!-- 공통 링크 -->

<h2>목록 보기(List) - 현재 페이지 : <%= pageNum %> (전체 : <%= totalPage %>)</h2>

<!-- 검색 폼 -->
<form method="get">
    <table border="1" width="90%">
        <tr>
            <td align="center">
                <select name="searchField">
                    <option value="title" <%= searchField.equals("title") ? "selected" : "" %>>제목</option>
                    <option value="content" <%= searchField.equals("content") ? "selected" : "" %>>내용</option>
                </select>
                <input type="text" name="searchWord" value="<%= searchWord != null ? searchWord : "" %>" />
                <input type="submit" value="검색하기" />
            </td>
        </tr>
    </table>
</form>

<!-- 게시물 목록 테이블 -->
<table border="1" width="90%">
    <!-- 칼럼 이름 -->
    <tr>
        <th width="10%">번호</th>
        <th width="50%">제목</th>
        <th width="15%">작성자</th>
        <th width="10%">조회수</th>
        <th width="15%">작성일</th>
    </tr>

    <!-- 목록 내용 -->
    <%
    if (boardLists.isEmpty()) {
        // 게시물이 없을 때
    %>
        <tr>
            <td colspan="5" align="center">등록된 게시물이 없습니다^^*</td>
        </tr>
    <%
    } else {
        // 게시물이 있을 때
        int virtualNum = totalCount - (start + 1); // 가상 게시물 번호
        for (BoardDTO dto : boardLists) {
    %>
            <tr align="center">
                <td><%= ++virtualNum %></td>
                <td align="left">
                    <a href="View.jsp?num=<%= dto.getNum() %>&searchField=<%= searchField %>&searchWord=<%= searchWord %>"><%= dto.getTitle() %></a>
                </td>
                <td><%= dto.getId() %></td>
                <td><%= dto.getVisitcount() %></td>
                <td><%= dto.getPostdate() %></td>
            </tr>
    <%
        }
    }
    %>
</table>

<!-- 페이징과 글쓰기 버튼 -->
<table border="1" width="90%">
    <tr align="center">
        <td><%= BoardPage.pagingStr(totalCount, pageSize, blockPage, pageNum, request.getRequestURI(), searchField, searchWord) %></td>
        <td><button type="button" onclick="location.href='Write.jsp';">글쓰기</button></td>
    </tr>
</table>

</body>
</html>
